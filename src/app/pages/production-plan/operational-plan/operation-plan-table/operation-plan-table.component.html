@if (getSelectedElemCount) {
	<ss-lib-action-bar
		[showClose]="true"
		(closed)="popupCloseEmit()"
	>
		<ss-lib-action-bar-item
			[type]="ActionBarItemType.Info"
			[leftIconConfig]="{
				icon: IconType.CheckCircle,
				color: Colors.IconInformation,
			}"
			[text]="
				`Выбрано элементов: ${getSelectedElemCount} из ${totalItems()}`
			"
		/>
		<ss-lib-action-bar-item
			[leftIconConfig]="{
				icon: IconType.FileSearch02,
			}"
			[rightIconConfig]="{
				icon: IconType.ChevronDown,
			}"
			[text]="'Заказ наряд'"
			[popoverTriggerFor]="orderAnOutfitList"
		/>
		<ss-lib-action-bar-item
			[leftIconConfig]="{
				icon: IconType.FilePreviewSearch,
			}"
			[rightIconConfig]="{
				icon: IconType.ChevronDown,
			}"
			[text]="'Рассчитать сырье'"
			[popoverTriggerFor]="calcProd"
		/>
		<ss-lib-action-bar-item
			[leftIconConfig]="{
				icon: IconType.Trash,
			}"
			[text]="'Удалить'"
			(click)="deleteItemsTov()"
		/>
	</ss-lib-action-bar>
}

<ss-lib-dropdown-list
	#calcProd
	[width]="'155px'"
>
	<ss-lib-dropdown-item
		*ngFor="let day of days()"
		(click)="openCalculationOfRawMaterialsForCheckList(day.day)"
	>
		{{ day.day | date: 'dd.MM' }}
	</ss-lib-dropdown-item>
</ss-lib-dropdown-list>

<ss-lib-dropdown-list
	#orderAnOutfitList
	[width]="'155px'"
>
	<ss-lib-dropdown-item
		*ngFor="let day of days()"
		(click)="orderAnOutfitForCheckList(day)"
	>
		{{ day.day | date: 'dd.MM' }}
	</ss-lib-dropdown-item>
</ss-lib-dropdown-list>

<table
	ssTable
	class="operation-plan-table"
	[hasBorderRadius]="false"
	[showCellBorders]="true"
	[columns]="visibleColumnsIds()"
>
	<thead>
		<tr ssThGroup>
			@for (column of visibleColumns(); track column) {
				@if (!isSubColumn(column.id)) {
					<th
						*ssHead="column.id"
						ssTh
						[attr.rowspan]="
							!column.subColumns && !column.subGroups ? 2 : null
						"
						[attr.colspan]="
							column.subColumns ? column.subColumns.length : null
						"
						[resizable]="true"
					>
						@if (column.id === 'tov') {
							<div class="td-column">
								<ss-lib-checkbox
									[formControl]="masterCheckboxCtrl"
									[indeterminate]="
										getMasterCheckboxIndeterminate()
									"
								/>
								<ss-lib-text
									[color]="Colors.TextBody2"
									[weight]="TextWeight.Semibold"
									[type]="TextType.BodyXs"
									[align]="Align.Center"
									[isEllipsis]="true"
								>
									{{ formatColumnName(column.name) }}
								</ss-lib-text>
							</div>
						} @else if (column.id.startsWith('week-')) {
							<div class="td-column item-day">
								<div class="item-day-text">
									<ss-lib-text
										[color]="Colors.TextBody2"
										[weight]="TextWeight.Semibold"
										[type]="TextType.BodyXs"
										[align]="Align.Center"
										[isEllipsis]="true"
									>
										{{ formatColumnName(column.name) }}
									</ss-lib-text>

									@if (isWmsUpload(column.name)) {
										<ss-lib-status-icon
											ss-lib-tooltip
											[type]="Status.Success"
											[icon]="IconType.CheckCircle"
											[position]="TooltipPosition.Top"
											[tooltipText]="
												'План выгружен в WMS'
											"
										></ss-lib-status-icon>
									}
								</div>
								<div class="item-day-utility">
									<ss-lib-utility-button
										[popoverTriggerFor]="listFunc"
										[icon]="IconType.KebabMenuDots"
									></ss-lib-utility-button>
									<ss-lib-dropdown-list #listFunc>
										<ss-lib-dropdown-item
											*ngIf="
												operationPlanState.getHasPermissionOrderProduction
											"
											[icon]="IconType.FilePreviewSearch"
											[label]="'Заказ наряд'"
											(click)="orderAnOutfit(column.id)"
										></ss-lib-dropdown-item>
										<ss-lib-dropdown-item
											*ngIf="
												operationPlanState.getHasPermissionUploadWMS
											"
											[icon]="IconType.FileUpload02"
											[label]="'Выгрузить в WMS'"
											(click)="uploadWMS(column.id)"
										></ss-lib-dropdown-item>
										<ss-lib-dropdown-item
											*ngIf="
												operationPlanState.getHasPermissionApproveMaterials
											"
											[icon]="IconType.FileCheck"
											[label]="'Согласовать сырье'"
											(click)="
												openApproveMaterials(column.id)
											"
										></ss-lib-dropdown-item>
										<ss-lib-dropdown-item
											*ngIf="
												operationPlanState.getHasPermissionCalcRowMaterials
											"
											[icon]="IconType.FileSearch02"
											[label]="'Рассчитать сырье'"
											(click)="
												openCalculationOfRawMaterialsForColumn(
													column.id
												)
											"
										></ss-lib-dropdown-item>
									</ss-lib-dropdown-list>
								</div>
							</div>
						} @else {
							<div class="td-column">
								<ss-lib-text
									[color]="Colors.TextBody2"
									[weight]="TextWeight.Semibold"
									[type]="TextType.BodyXs"
									[align]="Align.Center"
									[isEllipsis]="true"
								>
									{{ formatColumnName(column.name) }}
								</ss-lib-text>
							</div>
						}
					</th>
				}
			}
		</tr>
		<tr ssThGroup>
			@for (column of visibleColumns(); track column) {
				@if (column.subColumns) {
					@for (subColumnId of column.subColumns; track subColumnId) {
						<th
							*ssHead="subColumnId"
							ssTh
						>
							<div
								class="td-subcolumn"
								[style.justify-content]="'flex-end'"
							>
								<ss-lib-text
									[color]="Colors.TextBody2"
									[weight]="TextWeight.Semibold"
									[type]="TextType.BodyXs"
									[align]="Align.Center"
									[isEllipsis]="true"
								>
									{{ getSubColumnName(subColumnId) }}
								</ss-lib-text>
								@if (subColumnId.startsWith('planQuantity')) {
									<ss-lib-status-icon
										ss-lib-tooltip
										[icon]="IconType.Info"
										[position]="TooltipPosition.Top"
										[tooltipText]="planTooltipText"
										(mouseenter)="
											onPlanInfoEnter(subColumnId)
										"
									></ss-lib-status-icon>
								}
							</div>
						</th>
					}
				}
			}
		</tr>
	</thead>
	<tbody app-operation-plan-table-tbody></tbody>
</table>
